name: Data Collection

# This workflow collects environmental data for Ontario.
#
# Usage:
#   1. Go to Actions > Data Collection > Run workflow
#   2. Select "collect" mode (default)
#   3. Check which data sources you want to collect
#   4. Click "Run workflow"
#
# By default, Williams Treaty Communities and Provincial Parks are selected.
# You can select additional data sources or deselect the defaults as needed.

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'ðŸŽ¯ Mode'
        required: true
        type: choice
        options:
          - status-only
          - collect-all
          - collect-selected
        default: status-only
      datasets:
        description: 'ðŸ“‹ Datasets (comma-separated IDs, e.g., "inaturalist,ebird,fire_perimeters")'
        type: string
        required: false
        default: ''
      upload_artifacts:
        description: 'ðŸ“¦ Upload artifacts'
        type: boolean
        default: true
      force_refresh:
        description: 'ðŸ”„ Force refresh'
        type: boolean
        default: false

jobs:
  check-status:
    name: Check Data Status
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.check.outputs.status }}

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Check existing data status
      id: check
      run: |
        # Run status check but don't fail - this is just informational
        set +e  # Don't exit on error
        python check_data_status.py
        # Ignore exit code - missing data before collection is expected

        echo "## ðŸ“Š Current Data Status (Before Collection)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Status check completed before data collection." >> $GITHUB_STEP_SUMMARY
        echo "Note: Missing data is expected at this stage." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -f "data_status.json" ]; then
          echo "### Existing Data Files" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat data_status.json | python -m json.tool 2>/dev/null || cat data_status.json
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi

        # Always succeed - this is just informational
        exit 0

  collect-data:
    name: Collect Selected Data
    needs: check-status
    if: github.event.inputs.mode == 'collect'
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
    - uses: actions/checkout@v4

    - name: Show collection mode
      run: |
        echo "Collection mode: ${{ github.event.inputs.mode }}"
        if [ "${{ github.event.inputs.mode }}" == "collect-selected" ]; then
          echo "Selected datasets: ${{ github.event.inputs.datasets }}"
        fi

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Check before status
      run: |
        echo "=== DATA STATUS BEFORE COLLECTION ==="
        python check_data_status.py

    - name: Prepare data directories and files
      run: |
        # Create necessary directories
        mkdir -p data/raw data/processed

        # Download required CSV files if they don't exist
        # Note: Water advisories CSV - check if exists, if not download
        if [ ! -f "data/raw/water_advisories_historical.csv" ]; then
          echo "âš ï¸  Water advisories CSV not found - will be skipped in collection"
          echo "   Download from: https://www.sac-isc.gc.ca/eng/1506514143353/1533317130660"
        fi

        # CWB CSV - check if exists
        if [ ! -f "data/raw/CWB_2021.csv" ]; then
          echo "âš ï¸  Community Well-Being CSV not found - will be skipped in collection"
          echo "   Download from: https://www.sac-isc.gc.ca/eng/1419773101942/1419773233645"
        fi

        # Census boundaries shapefile - check if exists
        if [ ! -f "data/raw/lcsd000a21a_e.shp" ]; then
          echo "ðŸ“¥ Downloading Census Subdivision boundaries..."
          cd data/raw
          wget -q https://www12.statcan.gc.ca/census-recensement/2021/geo/sip-pis/boundary-limites/files-fichiers/lcsd000a21a_e.zip
          unzip -q lcsd000a21a_e.zip
          rm lcsd000a21a_e.zip
          cd ../..
          echo "âœ… Census boundaries downloaded"
        else
          echo "âœ… Census boundaries already exist"
        fi

    - name: Run data collection
      run: |
        echo "=========================================="
        echo "RUNNING DATA COLLECTION"
        echo "=========================================="
        echo ""
        echo "Mode: ${{ github.event.inputs.mode }}"

        if [ "${{ github.event.inputs.mode }}" == "collect-all" ]; then
          echo "Collecting ALL enabled datasets from registry"
          # Set all enabled datasets to true
          python3 -c "
from ontario_data.datasets import get_enabled_datasets
import os
for dataset in get_enabled_datasets():
    env_var = f'COLLECT_{dataset.id.upper()}'
    print(f'export {env_var}=true')
" > /tmp/env_vars.sh
          source /tmp/env_vars.sh

        elif [ "${{ github.event.inputs.mode }}" == "collect-selected" ]; then
          echo "Collecting selected datasets: ${{ github.event.inputs.datasets }}"
          # Parse comma-separated list and set env vars
          IFS=',' read -ra DATASETS <<< "${{ github.event.inputs.datasets }}"
          for dataset_id in "${DATASETS[@]}"; do
            dataset_id=$(echo "$dataset_id" | xargs)  # trim whitespace
            if [ ! -z "$dataset_id" ]; then
              env_var="COLLECT_${dataset_id^^}"
              export "$env_var=true"
              echo "  - $dataset_id ($env_var=true)"
            fi
          done
        fi

        python3 collect_data.py
      env:
        EBIRD_API_KEY: ${{ secrets.EBIRD_API_KEY }}


    - name: Check after status
      if: always()
      run: |
        echo ""
        echo "=== DATA STATUS AFTER COLLECTION ==="
        # Run status check (always exits 0, just reports data status)
        python check_data_status.py || true
        echo "Status check completed - see output above for details"

    - name: Upload data artifacts
      # Upload artifacts even if there were partial failures (but not if job was cancelled)
      if: github.event.inputs.upload_artifacts == 'true' && !cancelled()
      uses: actions/upload-artifact@v4
      with:
        name: ontario-data-${{ github.run_number }}
        path: |
          data/processed/**/*.geojson
          data/processed/**/*.json
          data/processed/**/*.csv
          data/processed/collection_report.json
          data_status.json
        retention-days: 30
        if-no-files-found: warn

    - name: Create collection summary
      if: always()
      run: |
        echo "## ðŸ“¦ Data Collection Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Run:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "**Force Refresh:** ${{ github.event.inputs.force_refresh }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "### Selected Data Sources" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Data Source | Selected |" >> $GITHUB_STEP_SUMMARY
        echo "|-------------|----------|" >> $GITHUB_STEP_SUMMARY
        echo "| Williams Treaty Communities | ${{ github.event.inputs.williams_treaty_communities == 'true' && 'âœ…' || 'â¬œ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Williams Treaty Boundaries | ${{ github.event.inputs.williams_treaty_boundaries == 'true' && 'âœ…' || 'â¬œ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Water Advisories | ${{ github.event.inputs.water_advisories == 'true' && 'âœ…' || 'â¬œ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Fire Perimeters | ${{ github.event.inputs.fire_perimeters == 'true' && 'âœ…' || 'â¬œ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Provincial Parks | ${{ github.event.inputs.provincial_parks == 'true' && 'âœ…' || 'â¬œ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Conservation Authorities | ${{ github.event.inputs.conservation_authorities == 'true' && 'âœ…' || 'â¬œ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| iNaturalist | ${{ github.event.inputs.inaturalist == 'true' && 'âœ…' || 'â¬œ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| eBird | ${{ github.event.inputs.ebird == 'true' && 'âœ…' || 'â¬œ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Community Well-Being | ${{ github.event.inputs.community_wellbeing == 'true' && 'âœ…' || 'â¬œ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Watersheds | ${{ github.event.inputs.watersheds == 'true' && 'âœ…' || 'â¬œ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Satellite Data | ${{ github.event.inputs.satellite == 'true' && 'âœ…' || 'â¬œ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "### Collection Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Full data collection script (collect_all_data.py) was executed." >> $GITHUB_STEP_SUMMARY
        echo "All available data sources were attempted." >> $GITHUB_STEP_SUMMARY
        echo "See collection_report.json for detailed results." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -f "data/processed/collection_report.json" ]; then
          echo "### Collection Results" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat data/processed/collection_report.json | python -m json.tool 2>/dev/null || cat data/processed/collection_report.json
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi

        if [ -f "data_status.json" ]; then
          echo "### Final Data Status" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          python check_data_status.py 2>&1 | tail -20
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
