name: Data Collection

# This workflow collects environmental data for Ontario.
#
# Usage:
#   1. Go to Actions > Data Collection > Run workflow
#   2. Select "collect" mode (default)
#   3. Check which data sources you want to collect
#   4. Click "Run workflow"
#
# By default, Williams Treaty Communities and Provincial Parks are selected.
# You can select additional data sources or deselect the defaults as needed.

on:
  workflow_dispatch:
    inputs:
      # Mode selection
      mode:
        description: 'ðŸŽ¯ Mode: Check status OR Collect data'
        required: true
        type: choice
        options:
          - status-only
          - collect
        default: status-only
      # Data source selection
      williams_treaty_communities:
        description: 'â˜ Williams Treaty Communities (community points)'
        type: boolean
        default: false
      williams_treaty_boundaries:
        description: 'â˜ Williams Treaty Boundaries (territory polygon) [âœ“ EXISTS]'
        type: boolean
        default: false
      water_advisories:
        description: 'â˜ Water Advisories (Indigenous communities - requires CSV)'
        type: boolean
        default: false
      fire_perimeters:
        description: 'â˜ Fire Perimeters (historical 1976-2024)'
        type: boolean
        default: false
      provincial_parks:
        description: 'â˜ Provincial Parks (Ontario parks)'
        type: boolean
        default: false
      conservation_authorities:
        description: 'â˜ Conservation Authorities (CA boundaries)'
        type: boolean
        default: false
      inaturalist:
        description: 'â˜ iNaturalist (biodiversity observations - 10K max)'
        type: boolean
        default: false
      ebird:
        description: 'â˜ eBird (bird observations - requires API key)'
        type: boolean
        default: false
      community_wellbeing:
        description: 'â˜ Community Well-Being Index (First Nations - requires CSV)'
        type: boolean
        default: false
      watersheds:
        description: 'â˜ Watersheds (Great Lakes watershed boundaries)'
        type: boolean
        default: false
      satellite:
        description: 'â˜ Satellite Data (NDVI, land cover info)'
        type: boolean
        default: false
      # Options
      upload_artifacts:
        description: 'ðŸ“¦ Upload generated data as artifacts (30 days)'
        type: boolean
        default: true
      force_refresh:
        description: 'ðŸ”„ Force refresh (re-download existing data)'
        type: boolean
        default: false

jobs:
  check-status:
    name: Check Data Status
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.check.outputs.status }}

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Check existing data status
      id: check
      run: |
        # Run status check but don't fail - this is just informational
        set +e  # Don't exit on error
        python check_data_status.py
        # Ignore exit code - missing data before collection is expected

        echo "## ðŸ“Š Current Data Status (Before Collection)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Status check completed before data collection." >> $GITHUB_STEP_SUMMARY
        echo "Note: Missing data is expected at this stage." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -f "data_status.json" ]; then
          echo "### Existing Data Files" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat data_status.json | python -m json.tool 2>/dev/null || cat data_status.json
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi

        # Always succeed - this is just informational
        exit 0

  collect-data:
    name: Collect Selected Data
    needs: check-status
    if: github.event.inputs.mode == 'collect'
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
    - uses: actions/checkout@v4

    - name: Validate data source selection
      run: |
        # Check if at least one data source is selected
        selected_count=0
        [ "${{ github.event.inputs.williams_treaty_communities }}" == "true" ] && selected_count=$((selected_count + 1))
        [ "${{ github.event.inputs.williams_treaty_boundaries }}" == "true" ] && selected_count=$((selected_count + 1))
        [ "${{ github.event.inputs.water_advisories }}" == "true" ] && selected_count=$((selected_count + 1))
        [ "${{ github.event.inputs.fire_perimeters }}" == "true" ] && selected_count=$((selected_count + 1))
        [ "${{ github.event.inputs.provincial_parks }}" == "true" ] && selected_count=$((selected_count + 1))
        [ "${{ github.event.inputs.conservation_authorities }}" == "true" ] && selected_count=$((selected_count + 1))
        [ "${{ github.event.inputs.inaturalist }}" == "true" ] && selected_count=$((selected_count + 1))
        [ "${{ github.event.inputs.ebird }}" == "true" ] && selected_count=$((selected_count + 1))
        [ "${{ github.event.inputs.community_wellbeing }}" == "true" ] && selected_count=$((selected_count + 1))
        [ "${{ github.event.inputs.watersheds }}" == "true" ] && selected_count=$((selected_count + 1))
        [ "${{ github.event.inputs.satellite }}" == "true" ] && selected_count=$((selected_count + 1))

        echo "Selected data sources: $selected_count"

        if [ $selected_count -eq 0 ]; then
          echo "::warning::No data sources selected! Using collect_all_data.py which will collect all available sources."
        else
          echo "âœ“ $selected_count data source(s) selected for collection"
        fi

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Check before status
      run: |
        echo "=== DATA STATUS BEFORE COLLECTION ==="
        python check_data_status.py

    - name: Prepare data directories and files
      run: |
        # Create necessary directories
        mkdir -p data/raw data/processed

        # Download required CSV files if they don't exist
        # Note: Water advisories CSV - check if exists, if not download
        if [ ! -f "data/raw/water_advisories_historical.csv" ]; then
          echo "âš ï¸  Water advisories CSV not found - will be skipped in collection"
          echo "   Download from: https://www.sac-isc.gc.ca/eng/1506514143353/1533317130660"
        fi

        # CWB CSV - check if exists
        if [ ! -f "data/raw/CWB_2021.csv" ]; then
          echo "âš ï¸  Community Well-Being CSV not found - will be skipped in collection"
          echo "   Download from: https://www.sac-isc.gc.ca/eng/1419773101942/1419773233645"
        fi

        # Census boundaries shapefile - check if exists
        if [ ! -f "data/raw/lcsd000a21a_e.shp" ]; then
          echo "ðŸ“¥ Downloading Census Subdivision boundaries..."
          cd data/raw
          wget -q https://www12.statcan.gc.ca/census-recensement/2021/geo/sip-pis/boundary-limites/files-fichiers/lcsd000a21a_e.zip
          unzip -q lcsd000a21a_e.zip
          rm lcsd000a21a_e.zip
          cd ../..
          echo "âœ… Census boundaries downloaded"
        else
          echo "âœ… Census boundaries already exist"
        fi

    - name: Run data collection
      run: |
        echo "=========================================="
        echo "RUNNING DATA COLLECTION"
        echo "=========================================="
        echo ""

        # Run the data collection script
        # Only collects sources where checkboxes are checked
        # If NO checkboxes are checked, nothing will be collected
        python3 collect_data.py
      env:
        EBIRD_API_KEY: ${{ secrets.EBIRD_API_KEY }}
        COLLECT_WILLIAMS_TREATY_COMMUNITIES: ${{ github.event.inputs.williams_treaty_communities }}
        COLLECT_WILLIAMS_TREATY_BOUNDARIES: ${{ github.event.inputs.williams_treaty_boundaries }}
        COLLECT_WATER_ADVISORIES: ${{ github.event.inputs.water_advisories }}
        COLLECT_FIRE_PERIMETERS: ${{ github.event.inputs.fire_perimeters }}
        COLLECT_PROVINCIAL_PARKS: ${{ github.event.inputs.provincial_parks }}
        COLLECT_CONSERVATION_AUTHORITIES: ${{ github.event.inputs.conservation_authorities }}
        COLLECT_INATURALIST: ${{ github.event.inputs.inaturalist }}
        COLLECT_EBIRD: ${{ github.event.inputs.ebird }}
        COLLECT_COMMUNITY_WELLBEING: ${{ github.event.inputs.community_wellbeing }}
        COLLECT_WATERSHEDS: ${{ github.event.inputs.watersheds }}
        COLLECT_SATELLITE: ${{ github.event.inputs.satellite }}


    - name: Check after status
      if: always()
      run: |
        echo ""
        echo "=== DATA STATUS AFTER COLLECTION ==="
        # Run status check (always exits 0, just reports data status)
        python check_data_status.py || true
        echo "Status check completed - see output above for details"

    - name: Upload data artifacts
      # Upload artifacts even if there were partial failures (but not if job was cancelled)
      if: github.event.inputs.upload_artifacts == 'true' && !cancelled()
      uses: actions/upload-artifact@v4
      with:
        name: ontario-data-${{ github.run_number }}
        path: |
          data/processed/**/*.geojson
          data/processed/**/*.json
          data/processed/**/*.csv
          data/processed/collection_report.json
          data_status.json
        retention-days: 30
        if-no-files-found: warn

    - name: Create collection summary
      if: always()
      run: |
        echo "## ðŸ“¦ Data Collection Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Run:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "**Force Refresh:** ${{ github.event.inputs.force_refresh }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "### Selected Data Sources" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Data Source | Selected |" >> $GITHUB_STEP_SUMMARY
        echo "|-------------|----------|" >> $GITHUB_STEP_SUMMARY
        echo "| Williams Treaty Communities | ${{ github.event.inputs.williams_treaty_communities == 'true' && 'âœ…' || 'â¬œ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Williams Treaty Boundaries | ${{ github.event.inputs.williams_treaty_boundaries == 'true' && 'âœ…' || 'â¬œ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Water Advisories | ${{ github.event.inputs.water_advisories == 'true' && 'âœ…' || 'â¬œ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Fire Perimeters | ${{ github.event.inputs.fire_perimeters == 'true' && 'âœ…' || 'â¬œ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Provincial Parks | ${{ github.event.inputs.provincial_parks == 'true' && 'âœ…' || 'â¬œ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Conservation Authorities | ${{ github.event.inputs.conservation_authorities == 'true' && 'âœ…' || 'â¬œ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| iNaturalist | ${{ github.event.inputs.inaturalist == 'true' && 'âœ…' || 'â¬œ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| eBird | ${{ github.event.inputs.ebird == 'true' && 'âœ…' || 'â¬œ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Community Well-Being | ${{ github.event.inputs.community_wellbeing == 'true' && 'âœ…' || 'â¬œ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Watersheds | ${{ github.event.inputs.watersheds == 'true' && 'âœ…' || 'â¬œ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Satellite Data | ${{ github.event.inputs.satellite == 'true' && 'âœ…' || 'â¬œ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "### Collection Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Full data collection script (collect_all_data.py) was executed." >> $GITHUB_STEP_SUMMARY
        echo "All available data sources were attempted." >> $GITHUB_STEP_SUMMARY
        echo "See collection_report.json for detailed results." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -f "data/processed/collection_report.json" ]; then
          echo "### Collection Results" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat data/processed/collection_report.json | python -m json.tool 2>/dev/null || cat data/processed/collection_report.json
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi

        if [ -f "data_status.json" ]; then
          echo "### Final Data Status" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          python check_data_status.py 2>&1 | tail -20
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
