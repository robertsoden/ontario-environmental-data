name: Data Scripts Validation

on:
  push:
    branches: [ main, claude/* ]
    paths:
      - 'collect_all_data.py'
      - 'generate_williams_treaty_data.py'
      - 'test_all_clients.py'
      - 'ontario_data/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'collect_all_data.py'
      - 'generate_williams_treaty_data.py'
      - 'test_all_clients.py'
      - 'ontario_data/**'

jobs:
  validate-scripts:
    name: Validate Data Collection Scripts
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Validate scripts syntax
      run: |
        python -m py_compile collect_all_data.py
        python -m py_compile generate_williams_treaty_data.py
        python -m py_compile test_all_clients.py

    - name: Check imports work
      run: |
        python -c "from ontario_data import *; print('✓ All imports successful')"

    - name: Run client integration tests (quick validation)
      run: |
        set -e  # Exit on any error
        timeout 300 python test_all_clients.py
      # Do NOT use continue-on-error - we want failures to fail the build

    - name: Check if data directory exists
      id: check_data
      run: |
        if [ -d "data/processed" ] && [ "$(ls -A data/processed 2>/dev/null)" ]; then
          echo "has_data=true" >> $GITHUB_OUTPUT
          echo "Data directory exists with files"
        else
          echo "has_data=false" >> $GITHUB_OUTPUT
          echo "No data directory or empty - skipping data validation"
        fi

    - name: Validate existing data (if present)
      if: steps.check_data.outputs.has_data == 'true'
      run: |
        echo "Validating existing data files..."
        python check_data_status.py
        # Exit code from check_data_status.py will determine if this step fails
        # 0 = success, 1 = critical failure, 2 = partial failure (we'll allow this)
        exit_code=$?
        if [ $exit_code -eq 1 ]; then
          echo "::error::Critical data validation failure"
          exit 1
        elif [ $exit_code -eq 2 ]; then
          echo "::warning::Some non-critical data files have issues"
          exit 0  # Don't fail build for non-critical issues
        else
          echo "All data validated successfully"
          exit 0
        fi

    - name: Validation summary
      if: always()
      run: |
        echo "## Data Scripts Validation" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "✓ Scripts syntax validated" >> $GITHUB_STEP_SUMMARY
        echo "✓ Import checks passed" >> $GITHUB_STEP_SUMMARY
        echo "✓ Client integration tests passed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -f "data_status.json" ]; then
          echo "### Data Validation Results" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat data_status.json | python -m json.tool 2>/dev/null || echo "Could not parse data_status.json"
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "**Note:** No existing data to validate" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Note:** Full data collection must be triggered manually via workflow_dispatch" >> $GITHUB_STEP_SUMMARY
